openapi: 3.0.3
info:
  title: TaskFlow API
  description: |
    API สำหรับระบบจัดการงานและทรัพยากรองค์กร (Task & Resource Management System)
    
    ## Authentication
    API ใช้ JWT Bearer Token สำหรับการยืนยันตัวตน
    ```
    Authorization: Bearer <token>
    ```
    
    ## Rate Limiting
    - Login endpoint: 5 requests/minute per IP
    - Other endpoints: ไม่จำกัด (ในเวอร์ชันปัจจุบัน)
    
    ## Roles
    - **ADMIN** - ผู้ดูแลระบบ
    - **CUSTOMER_SERVICE** - ฝ่ายบริการลูกค้า
    - **FINANCE_LEADER** - หัวหน้าฝ่ายการเงิน
    - **FINANCE** - เจ้าหน้าที่การเงิน
    - **SALES_LEADER** - หัวหน้าฝ่ายขาย
    - **SALES** - พนักงานขาย
    - **HEAD_TECH** - หัวหน้าแผนกช่าง
    - **LEADER** - หัวหน้าทีม
    - **TECH** - ช่าง
    
  version: 1.0.0
  contact:
    name: TaskFlow Support
    email: support@taskflow.com

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://taskflow.example.com/api
    description: Production server

tags:
  - name: Auth
    description: การยืนยันตัวตน
  - name: Users
    description: จัดการผู้ใช้งาน
  - name: Tasks
    description: จัดการงาน
  - name: Cars
    description: จัดการรถ/ยานพาหนะ
  - name: Leaves
    description: จัดการการลา
  - name: Dashboard
    description: ข้อมูลสถิติ Dashboard
  - name: Notifications
    description: การแจ้งเตือน

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token ที่ได้จาก /auth/login

  schemas:
    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
        message:
          type: string
        error:
          type: string

    PaginatedResponse:
      type: object
      properties:
        data:
          type: array
          items: {}
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
        totalPages:
          type: integer

    User:
      type: object
      properties:
        id:
          type: string
        employeeId:
          type: string
        email:
          type: string
          format: email
        name:
          type: string
        phone:
          type: string
        avatar:
          type: string
        role:
          $ref: '#/components/schemas/Role'
        departmentId:
          type: string
        subUnitId:
          type: string
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time

    Role:
      type: string
      enum:
        - ADMIN
        - CUSTOMER_SERVICE
        - FINANCE_LEADER
        - FINANCE
        - SALES_LEADER
        - SALES
        - HEAD_TECH
        - LEADER
        - TECH

    Task:
      type: object
      properties:
        id:
          type: string
        jobNumber:
          type: string
        title:
          type: string
        description:
          type: string
        location:
          type: string
        customerName:
          type: string
        customerPhone:
          type: string
        status:
          $ref: '#/components/schemas/TaskStatus'
        priority:
          type: integer
          minimum: 1
          maximum: 5
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        startTime:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
        endTime:
          type: string
          pattern: '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$'
        subUnitId:
          type: string
        carId:
          type: string
        createdById:
          type: string
        createdAt:
          type: string
          format: date-time

    TaskStatus:
      type: string
      enum:
        - WAITING
        - IN_PROGRESS
        - DONE
        - CANCELLED

    Car:
      type: object
      properties:
        id:
          type: string
        plateNumber:
          type: string
        name:
          type: string
        type:
          type: string
        brand:
          type: string
        model:
          type: string
        status:
          $ref: '#/components/schemas/CarStatus'
        mileage:
          type: integer
        description:
          type: string
        createdAt:
          type: string
          format: date-time

    CarStatus:
      type: string
      enum:
        - AVAILABLE
        - IN_USE
        - MAINTENANCE
        - OUT_OF_SERVICE

    Leave:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        type:
          $ref: '#/components/schemas/LeaveType'
        status:
          $ref: '#/components/schemas/LeaveStatus'
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        totalDays:
          type: number
        reason:
          type: string
        durationType:
          $ref: '#/components/schemas/LeaveDurationType'
        createdAt:
          type: string
          format: date-time

    LeaveType:
      type: string
      enum:
        - SICK
        - PERSONAL
        - VACATION
        - BIRTHDAY
        - OTHER

    LeaveStatus:
      type: string
      enum:
        - PENDING
        - APPROVED
        - REJECTED
        - CANCELLED

    LeaveDurationType:
      type: string
      enum:
        - FULL_DAY
        - HALF_DAY
        - TIME_BASED

    DashboardStats:
      type: object
      properties:
        totalTasks:
          type: integer
        pendingTasks:
          type: integer
        inProgressTasks:
          type: integer
        completedTasks:
          type: integer
        totalUsers:
          type: integer
        activeUsers:
          type: integer
        pendingLeaves:
          type: integer
        totalCars:
          type: integer
        availableCars:
          type: integer

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 1

    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          minLength: 2
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6
        phone:
          type: string
        departmentId:
          type: string

    CreateTaskRequest:
      type: object
      required:
        - title
        - startDate
        - endDate
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        location:
          type: string
          maxLength: 500
        customerName:
          type: string
          maxLength: 200
        customerPhone:
          type: string
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        startTime:
          type: string
          default: '09:00'
        endTime:
          type: string
          default: '17:00'
        subUnitId:
          type: string
        priority:
          type: integer
          minimum: 1
          maximum: 5
          default: 1

    CreateCarRequest:
      type: object
      required:
        - plateNumber
        - name
      properties:
        plateNumber:
          type: string
          minLength: 1
          maxLength: 20
        name:
          type: string
          minLength: 1
          maxLength: 100
        type:
          type: string
        brand:
          type: string
        model:
          type: string
        description:
          type: string

    CreateLeaveRequest:
      type: object
      required:
        - type
        - startDate
        - endDate
      properties:
        type:
          $ref: '#/components/schemas/LeaveType'
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        reason:
          type: string
        durationType:
          $ref: '#/components/schemas/LeaveDurationType'
        halfDayPeriod:
          type: string
          enum: [MORNING, AFTERNOON]
        startTime:
          type: string
        endTime:
          type: string

  responses:
    Unauthorized:
      description: ไม่ได้ยืนยันตัวตน
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'
          example:
            success: false
            error: กรุณาเข้าสู่ระบบ

    Forbidden:
      description: ไม่มีสิทธิ์เข้าถึง
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'
          example:
            success: false
            error: ไม่มีสิทธิ์เข้าถึง

    BadRequest:
      description: ข้อมูลไม่ถูกต้อง
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'
          example:
            success: false
            error: กรุณากรอกข้อมูลให้ครบถ้วน

    NotFound:
      description: ไม่พบข้อมูล
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'
          example:
            success: false
            error: ไม่พบข้อมูล

    TooManyRequests:
      description: ส่งคำขอมากเกินไป
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'
          example:
            success: false
            error: ขออภัย คุณส่งคำขอมากเกินไป กรุณารอสักครู่

paths:
  # ==================== Auth ====================
  /auth/login:
    post:
      tags: [Auth]
      summary: เข้าสู่ระบบ
      description: Login ด้วย email และ password เพื่อรับ JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: เข้าสู่ระบบสำเร็จ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          token:
                            type: string
                          user:
                            $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: รหัสผ่านไม่ถูกต้อง
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /auth/register:
    post:
      tags: [Auth]
      summary: ลงทะเบียนผู้ใช้ใหม่
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: ลงทะเบียนสำเร็จ
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: ขอรีเซ็ตรหัสผ่าน
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: ส่งอีเมลรีเซ็ตรหัสผ่านแล้ว (ถ้าอีเมลมีในระบบ)
    patch:
      tags: [Auth]
      summary: รีเซ็ตรหัสผ่านด้วย token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, password]
              properties:
                token:
                  type: string
                password:
                  type: string
                  minLength: 6
      responses:
        '200':
          description: รีเซ็ตรหัสผ่านสำเร็จ
        '400':
          description: Token ไม่ถูกต้องหรือหมดอายุ

  /auth/me:
    get:
      tags: [Auth]
      summary: ดึงข้อมูลผู้ใช้ปัจจุบัน
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ข้อมูลผู้ใช้
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==================== Users ====================
  /users:
    get:
      tags: [Users]
      summary: ดึงรายชื่อผู้ใช้
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 100
        - name: search
          in: query
          schema:
            type: string
        - name: role
          in: query
          description: comma-separated roles
          schema:
            type: string
        - name: departmentId
          in: query
          schema:
            type: string
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: รายชื่อผู้ใช้
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        allOf:
                          - $ref: '#/components/schemas/PaginatedResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Users]
      summary: สร้างผู้ใช้ใหม่
      description: ต้องมีสิทธิ์ canManageUsers
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [employeeId, email, password, name, role]
              properties:
                employeeId:
                  type: string
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                name:
                  type: string
                phone:
                  type: string
                role:
                  $ref: '#/components/schemas/Role'
                departmentId:
                  type: string
                subUnitId:
                  type: string
      responses:
        '200':
          description: สร้างผู้ใช้สำเร็จ
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== Tasks ====================
  /tasks:
    get:
      tags: [Tasks]
      summary: ดึงรายการงาน
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: search
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/TaskStatus'
        - name: subUnitId
          in: query
          schema:
            type: string
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: รายการงาน
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Tasks]
      summary: สร้างงานใหม่
      description: ต้องมีสิทธิ์ canCreateTasks
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTaskRequest'
      responses:
        '200':
          description: สร้างงานสำเร็จ
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /tasks/{id}:
    get:
      tags: [Tasks]
      summary: ดึงรายละเอียดงาน
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: รายละเอียดงาน
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Tasks]
      summary: อัปเดตงาน
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: อัปเดตสำเร็จ
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Tasks]
      summary: ลบงาน
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: ลบสำเร็จ
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== Cars ====================
  /cars:
    get:
      tags: [Cars]
      summary: ดึงรายการรถ
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
        - name: search
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/CarStatus'
      responses:
        '200':
          description: รายการรถ
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Cars]
      summary: เพิ่มรถใหม่
      description: ต้องมีสิทธิ์ canManageCars (HEAD_TECH, ADMIN)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCarRequest'
      responses:
        '200':
          description: เพิ่มรถสำเร็จ
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== Leaves ====================
  /leaves:
    get:
      tags: [Leaves]
      summary: ดึงรายการลา
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/LeaveStatus'
        - name: userId
          in: query
          schema:
            type: string
        - name: pendingApproval
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: รายการลา
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Leaves]
      summary: ส่งคำขอลา
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLeaveRequest'
      responses:
        '200':
          description: ส่งคำขอลาสำเร็จ
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /leaves/{id}:
    patch:
      tags: [Leaves]
      summary: อนุมัติ/ปฏิเสธคำขอลา
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  $ref: '#/components/schemas/LeaveStatus'
                approvalNote:
                  type: string
      responses:
        '200':
          description: อัปเดตสำเร็จ
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== Dashboard ====================
  /dashboard:
    get:
      tags: [Dashboard]
      summary: ดึงสถิติ Dashboard
      description: |
        สถิติที่แสดงจะแตกต่างตาม role:
        - LEADER: ดูเฉพาะข้อมูลทีมตัวเอง
        - ADMIN: ดูข้อมูลทั้งหมด
      security:
        - bearerAuth: []
      responses:
        '200':
          description: สถิติ Dashboard
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DashboardStats'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==================== Notifications ====================
  /notifications:
    get:
      tags: [Notifications]
      summary: ดึงการแจ้งเตือน
      security:
        - bearerAuth: []
      responses:
        '200':
          description: รายการแจ้งเตือน
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      tags: [Notifications]
      summary: อัปเดตสถานะการอ่าน
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                isRead:
                  type: boolean
      responses:
        '200':
          description: อัปเดตสำเร็จ
        '401':
          $ref: '#/components/responses/Unauthorized'
