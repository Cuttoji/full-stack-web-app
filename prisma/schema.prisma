// Prisma Schema for Task & Resource Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Role {
  ADMIN            // ผู้บริหารสูงสุด
  CUSTOMER_SERVICE // ฝ่ายบริการลูกค้า
  FINANCE_LEADER   // หัวหน้าฝ่ายการเงิน
  FINANCE          // เจ้าหน้าที่การเงิน
  SALES_LEADER     // หัวหน้าฝ่ายขาย
  SALES            // พนักงานขาย
  HEAD_TECH        // หัวหน้าแผนกช่าง
  LEADER           // หัวหน้าทีม
  TECH             // ช่าง
}

enum TaskStatus {
  WAITING     // รอรับงาน (สีเทา)
  IN_PROGRESS // กำลังทำ (สีฟ้า)
  DONE        // จบงาน (สีเขียว)
  CANCELLED   // ยกเลิก (สีแดง)
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveType {
  SICK        // ลาป่วย
  PERSONAL    // ลากิจ
  VACATION    // ลาพักร้อน
  BIRTHDAY    // ลาเดือนเกิด
  OTHER       // อื่นๆ
}

enum LeaveDurationType {
  FULL_DAY    // เต็มวัน
  HALF_DAY    // ครึ่งวัน
  TIME_BASED  // ตามเวลา
}

enum HalfDayPeriod {
  MORNING     // ช่วงเช้า
  AFTERNOON   // ช่วงบ่าย
}

enum SubUnitType {
  RENTAL       // ทีมเครื่องเช่า
  INSTALLATION // ทีมติดตั้ง
  PRINTER      // ทีมปริ้นเตอร์
  IT           // ทีมไอที
}

enum CarStatus {
  AVAILABLE       // พร้อมใช้งาน
  IN_USE          // กำลังใช้งาน
  MAINTENANCE     // ซ่อมบำรุง
  OUT_OF_SERVICE  // ปิดการใช้งาน
}

enum LeaveApprovalStatus {
  PENDING
  APPROVED  
  REJECTED
}

enum PermissionScopeType {
  ALL
  DEPARTMENT
  SUBUNIT
  TEAM
  SELF
}

// ==================== MODELS ====================

// แผนก (ฝ่ายขาย, การเงิน, แผนกช่าง)
model Department {
  id        String   @id @default(cuid())
  name      String   @unique // ฝ่ายขาย, การเงิน, แผนกช่าง
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    User[]
  subUnits SubUnit[]

  @@map("departments")
}

// กลุ่มย่อย (เฉพาะแผนกช่าง: เครื่องเช่า, ติดตั้ง, ปริ้นเตอร์)
model SubUnit {
  id           String      @id @default(cuid())
  name         String      // เครื่องเช่า, ติดตั้ง, ปริ้นเตอร์
  type         SubUnitType
  departmentId String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  users      User[]
  tasks      Task[]

  @@index([departmentId])
  @@index([type])
  @@map("sub_units")
}

// ผู้ใช้งาน
model User {
  id            String   @id @default(cuid())
  employeeId    String   @unique // รหัสพนักงาน
  email         String   @unique
  password      String
  name          String
  phone         String?
  avatar        String?
  role          Role     @default(TECH)
  departmentId  String?
  subUnitId     String?  // สำหรับ Tech ในแผนกช่าง
  supervisorId  String?  // ผู้บังคับบัญชาโดยตรง (สำหรับ Hierarchical Approval)
  leaveQuota    Int      @default(15) // โควตาลาประจำปี (วัน) - Legacy
  leaveUsed     Int      @default(0)  // วันลาที่ใช้ไปแล้ว - Legacy
  birthMonth    Int?     // เดือนเกิด (1-12)
  birthDate     DateTime? // วันเกิด
  employmentStartDate DateTime? // วันเข้างาน
  isActive      Boolean  @default(true)
  permissions   Json?    // Custom permissions (UserPermissions)
  permissionScope Json?  // Permission scope (PermissionScope)
  
  // Password Reset
  resetToken       String?   // Hashed reset token
  resetTokenExpiry DateTime? // Token expiry time
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  department     Department?     @relation(fields: [departmentId], references: [id])
  subUnit        SubUnit?        @relation(fields: [subUnitId], references: [id])
  supervisor     User?           @relation("UserSupervisor", fields: [supervisorId], references: [id])
  subordinates   User[]          @relation("UserSupervisor")
  
  // Relations
  tasksCreated   Task[]          @relation("TaskCreator")
  tasksAssigned  TaskAssignment[]
  leavesRequested Leave[]        @relation("LeaveRequester")
  leavesApproved Leave[]         @relation("LeaveApprover")
  leaveApprovalsGiven LeaveApproval[] @relation("LeaveApprovalApprover")
  printerLogs    PrinterLog[]
  taskImages     TaskImage[]
  notifications  Notification[]
  activityLogs   ActivityLog[]

  @@index([departmentId])
  @@index([subUnitId])
  @@index([supervisorId])
  @@index([role])
  @@map("users")
}

// รถ/เครื่องมือ
model Car {
  id              String    @id @default(cuid())
  plateNumber     String    @unique // ทะเบียนรถ
  licensePlate    String?   // ทะเบียนรถ (alternative)
  name            String    // ชื่อรถ/เครื่องมือ
  type            String?   // ประเภท
  brand           String?   // ยี่ห้อ
  model           String?   // รุ่น
  year            Int?      // ปี
  mileage         Int?      // เลขไมล์
  status          CarStatus @default(AVAILABLE)
  description     String?
  lastMaintenance DateTime? // วันซ่อมบำรุงล่าสุด
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tasks Task[]

  @@index([status])
  @@map("cars")
}

// งาน (Job Order)
model Task {
  id            String     @id @default(cuid())
  jobNumber     String     @unique // เลขที่งาน (Auto-generate)
  title         String
  description   String?
  location      String?    // สถานที่
  customerName  String?    // ชื่อลูกค้า
  customerPhone String?    // เบอร์ลูกค้า
  scheduledDate DateTime?  // วันที่กำหนด (สำหรับ Calendar)
  startDate     DateTime
  endDate       DateTime
  startTime     String?    // เวลาเริ่ม (HH:mm)
  endTime       String?    // เวลาสิ้นสุด (HH:mm)
  status        TaskStatus @default(WAITING)
  isLoop        Boolean    @default(false) // งานวนซ้ำ
  loopPattern   String?    // รูปแบบการวนซ้ำ (daily, weekly, monthly)
  loopInterval  Int?       // ระยะห่างการวนซ้ำ
  loopEndDate   DateTime?  // วันสิ้นสุดการวนซ้ำ
  parentTaskId  String?    // สำหรับงาน Loop (อ้างอิงงานหลัก)
  subUnitId     String?    // กลุ่มงาน
  carId         String?    // รถที่ใช้
  createdById   String     // ผู้สร้างงาน
  notes        String?    // หมายเหตุ
  completedAt  DateTime?  // เวลาที่จบงาน
  deletedAt    DateTime?  // Soft delete - ถังขยะ
  deletedById  String?    // ผู้ลบ
  
  // Document tracking fields
  documentDetails     String?   // รายละเอียดเอกสาร
  documentsComplete   Boolean   @default(false) // เอกสารครบหรือไม่ (ช่างตรวจสอบ)
  documentNotes       String?   // หมายเหตุเอกสาร (ถ้าไม่ครบ)
  documentConfirmed   Boolean   @default(false) // ยืนยันเอกสารจาก Admin/Finance
  documentConfirmedBy String?   // ผู้ยืนยันเอกสาร
  documentConfirmedAt DateTime? // วันที่ยืนยันเอกสาร
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  subUnit      SubUnit?         @relation(fields: [subUnitId], references: [id])
  car          Car?             @relation(fields: [carId], references: [id])
  createdBy    User             @relation("TaskCreator", fields: [createdById], references: [id])
  parentTask   Task?            @relation("TaskLoop", fields: [parentTaskId], references: [id])
  childTasks   Task[]           @relation("TaskLoop")
  assignments  TaskAssignment[]
  images       TaskImage[]
  printerLogs  PrinterLog[]
  activityLogs ActivityLog[]

  @@index([status])
  @@index([startDate, endDate])
  @@index([subUnitId])
  @@index([createdById])
  @@index([scheduledDate])
  @@index([carId])
  @@map("tasks")
}

// การมอบหมายงาน (หนึ่งงานมีได้หลายคน)
model TaskAssignment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  isLead    Boolean  @default(false) // หัวหน้าทีมในงานนี้
  isPrimary Boolean  @default(false) // ช่างหลักของงาน
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
  @@map("task_assignments")
}

// รูปภาพประกอบงาน (ก่อน-หลัง)
model TaskImage {
  id          String   @id @default(cuid())
  taskId      String
  uploadedBy  String
  imageUrl    String
  imageType   String   // BEFORE, AFTER, EVIDENCE
  description String?
  createdAt   DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [uploadedBy], references: [id])

  @@index([taskId])
  @@map("task_images")
}

// Log สำหรับงานปริ้นเตอร์ (Printer Specialization)
model PrinterLog {
  id            String   @id @default(cuid())
  taskId        String
  technicianId  String
  printerModel  String?  // รุ่นเครื่องพิมพ์
  serialNumber  String?  // Serial Number
  symptom       String   // อาการ/ปัญหา
  diagnosis     String?  // การวินิจฉัย
  solution      String   // วิธีแก้ไข
  partsUsed     String?  // อะไหล่ที่ใช้
  partsDetail   Json?    // รายละเอียดอะไหล่ [{name, quantity, price}]
  laborTime     Int?     // เวลาทำงาน (นาที)
  rating        Int?     // คะแนนประเมิน 1-5
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  technician User @relation(fields: [technicianId], references: [id])

  @@index([taskId])
  @@index([technicianId])
  @@map("printer_logs")
}

// การลา
model Leave {
  id              String      @id @default(cuid())
  userId          String
  type            LeaveType
  status          LeaveStatus @default(PENDING)
  startDate       DateTime
  endDate         DateTime
  totalDays       Float       // จำนวนวันลา (รองรับ 0.5 วัน)
  minutesUsed     Int?        // นาทีที่ใช้จริง (หักพักเที่ยงแล้ว) สำหรับคำนวณโควต้า
  reason          String?     // เหตุผลการลา
  
  // Leave Duration Options
  durationType    LeaveDurationType @default(FULL_DAY) // ประเภทการลา
  halfDayPeriod   HalfDayPeriod? // ช่วงครึ่งวัน (เช้า/บ่าย)
  startTime       String?     // เวลาเริ่ม (สำหรับ TIME_BASED)
  endTime         String?     // เวลาสิ้นสุด (สำหรับ TIME_BASED)
  
  // Hierarchical Approval
  currentApproverId String?   // ผู้ที่ต้องอนุมัติปัจจุบัน
  approvalLevel   Int         @default(1) // ระดับการอนุมัติปัจจุบัน
  
  // Legacy fields (for backward compatibility)
  approvedById    String?     // ผู้อนุมัติสุดท้าย
  approvedAt      DateTime?
  rejectedReason  String?     // เหตุผลที่ไม่อนุมัติ
  approverNote    String?     // หมายเหตุจากผู้อนุมัติ
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation("LeaveRequester", fields: [userId], references: [id], onDelete: Cascade)
  approvedBy      User?       @relation("LeaveApprover", fields: [approvedById], references: [id])
  approvalChain   LeaveApproval[]

  @@index([userId])
  @@index([status])
  @@index([currentApproverId])
  @@index([startDate, endDate])
  @@index([userId, status])
  @@index([type])
  @@map("leaves")
}

// ยอดโควตาการลาต่อปี (เก็บประวัติการใช้โควตาแต่ละประเภท)
model LeaveQuota {
  id          String    @id @default(cuid())
  userId      String
  year        Int       // ปี พ.ศ. หรือ ค.ศ.
  leaveType   LeaveType
  totalQuota  Float     // โควตาทั้งหมด
  usedDays    Float     @default(0) // ใช้ไปแล้ว
  pendingDays Float     @default(0) // รออนุมัติ
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, year, leaveType])
  @@index([userId, year])
  @@map("leave_quotas")
}

// ประวัติการอนุมัติตามลำดับชั้น
model LeaveApproval {
  id            String              @id @default(cuid())
  leaveId       String
  approverId    String
  approverRole  Role
  level         Int                 // ลำดับการอนุมัติ (1, 2, 3...)
  status        LeaveApprovalStatus @default(PENDING)
  comment       String?
  actionAt      DateTime?
  createdAt     DateTime            @default(now())

  leave    Leave @relation(fields: [leaveId], references: [id], onDelete: Cascade)
  approver User  @relation("LeaveApprovalApprover", fields: [approverId], references: [id])

  @@index([leaveId])
  @@index([approverId])
  @@map("leave_approvals")
}

// การแจ้งเตือน
model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // TASK, LEAVE, CONFLICT, SYSTEM
  link      String?  // Link ไปยังหน้าที่เกี่ยวข้อง
  isRead    Boolean  @default(false)
  data      Json?    // ข้อมูลเพิ่มเติม
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
  @@map("notifications")
}

// Activity Log (สำหรับ Offline Sync และติดตามการเปลี่ยนแปลง)
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // CREATE, UPDATE, DELETE, STATUS_CHANGE
  entityType  String   // TASK, LEAVE, USER, etc.
  entityId    String
  oldData     Json?
  newData     Json?
  taskId      String?  // Reference to task if related
  syncStatus  String   @default("SYNCED") // PENDING, SYNCED, FAILED
  deviceId    String?  // สำหรับ Offline sync
  createdAt   DateTime @default(now())

  user User  @relation(fields: [userId], references: [id])
  task Task? @relation(fields: [taskId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([syncStatus])
  @@map("activity_logs")
}

// Offline Queue (สำหรับเก็บข้อมูลที่รอ Sync)
model OfflineQueue {
  id        String   @id @default(cuid())
  deviceId  String
  action    String
  endpoint  String
  method    String
  payload   Json
  status    String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  retryCount Int     @default(0)
  error     String?
  createdAt DateTime @default(now())
  processedAt DateTime?

  @@index([deviceId, status])
  @@map("offline_queue")
}

// System Settings
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
